&НаСервере
Процедура ПересчитатьСкидку(Элемент=Неопределено)
	// тестирование
	// Проверка
	Если НЕ ЗначениеЗаполнено(Объект.Скидка) Тогда 
		ПроцентСкидки = 1;
	Иначе
		ПроцентСкидки = 1-(Объект.Скидка.ПроцентСкидки/100);
	КонецЕсли;
	Если Элемент = Неопределено Тогда
		Для Каждого СтрокаТЧ из Объект.Услуги Цикл
			Если НЕ СтрокаТЧ.Скидка Тогда 
				СтрокаТЧ.СуммаИтого = СтрокаТЧ.Сумма;	
			Иначе	
				СтрокаТЧ.СуммаИтого = СтрокаТЧ.Сумма*ПроцентСкидки;	
			КонецЕсли;
		КонецЦикла;
	Иначе
		Если НЕ Объект.Услуги[Элемент].Скидка Тогда 
			Объект.Услуги[Элемент].СуммаИтого = Объект.Услуги[Элемент].Сумма;
		Иначе	
			Объект.Услуги[Элемент].СуммаИтого = Объект.Услуги[Элемент].Сумма*ПроцентСкидки;	
		КонецЕсли;
	КонецЕсли;	
Конецпроцедуры

&НаСервере
Процедура ПересчетСтроки(Элемент)
	Объект.Услуги[Элемент].Сумма = Объект.Услуги[Элемент].Цена*Объект.Услуги[Элемент].Количество;
	Объект.Услуги[Элемент].СуммаИтого = Объект.Услуги[Элемент].Сумма;
КонецПроцедуры

&НаКлиенте
Процедура УслугиУслугаПриИзменении(Элемент)
	ПересчитатьСкидку(Элементы.Услуги.ТекущаяСтрока);
	ОбновитьТестовыеДанныеСкидки();
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьТестовыеДанныеСкидки()
	Элементы.ТекстСкидки.Заголовок = ОбновитьТекстСкидки();
КонецПроцедуры

&НаКлиенте
Процедура ПересчитатьСтроку(СтрокаТЧ)
	ПересчетСтроки(СтрокаТЧ);
	ПересчитатьСкидку(СтрокаТЧ);
	ОбновитьТестовыеДанныеСкидки();
КонецПроцедуры

&НаСервере
Функция ОбновитьТекстСкидки()
	ИтогСуммыБезСкидки = Объект.Услуги.Итог("Сумма");
	ИтогСуммыСоСкидкой = Объект.Услуги.Итог("СуммаИтого");
	Если ИтогСуммыБезСкидки=0 Тогда Возврат ""; КонецЕсли;
	СуммаСкидка = ИтогСуммыБезСкидки - ИтогСуммыСоСкидкой;
	Если СуммаСкидка=0 Тогда
		Возврат "К уплате "+Формат(ИтогСуммыСоСкидкой,"ЧДЦ=2; ЧРД=.; ЧРГ=' '; ЧГ=3,0");
	Иначе
		Возврат "Итого "+Формат(ИтогСуммыБезСкидки,"ЧДЦ=2; ЧРД=.; ЧРГ=' '; ЧГ=3,0")+" , скидка "+Формат(СуммаСкидка,"ЧДЦ=2; ЧРД=.; ЧРГ=' '; ЧГ=3,0")+" , к уплате "+ Формат(ИтогСуммыСоСкидкой,"ЧДЦ=2; ЧРД=.; ЧРГ=' '; ЧГ=3,0");
	КонецЕсли;
КонецФункции

&НаКлиенте
Процедура СкидкаПриИзменении(Элемент)
	ПересчитатьСкидку();
	ОбновитьТестовыеДанныеСкидки();
	УстановитьВидимость();
КонецПроцедуры

&НаКлиенте
Процедура УслугиКоличествоПриИзменении(Элемент)
	ПересчитатьСтроку(Элементы.Услуги.ТекущаяСтрока);
КонецПроцедуры

&НаСервере
Процедура ОчиститьСкидку();
	Объект.Скидка = Справочники.Скидки.ПустаяСсылка();
КонецПроцедуры

&НаКлиенте
Процедура УстановитьВидимость()
	Элементы.Услуги.ПодчиненныеЭлементы.УслугиСкидка.Видимость = ЗначениеЗаполнено(Объект.Скидка);
КонецПроцедуры

&НаКлиенте
Процедура СкидкаОчистка(Элемент, СтандартнаяОбработка)
	ОчиститьСкидку();
	ПересчитатьСкидку();
	ОбновитьТестовыеДанныеСкидки();
	УстановитьВидимость();
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	ОбновитьТестовыеДанныеСкидки();
	УстановитьВидимость();
КонецПроцедуры

&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)
	Объект.СуммаДокумента = Объект.Услуги.Итог("СуммаИтого"); 
КонецПроцедуры

&НаКлиенте
Процедура УслугиСкидкаПриИзменении(Элемент)
	ПересчитатьСтроку(Элементы.Услуги.ТекущаяСтрока)	
КонецПроцедуры
